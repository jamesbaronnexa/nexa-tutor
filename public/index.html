<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Course Tutor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .status {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .main-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .main-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .main-button.stop {
            background: #dc3545;
        }
        
        .main-button.stop:hover {
            background: #c82333;
        }
        
        .audio-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            height: 60px;
        }
        
        .audio-bar {
            width: 4px;
            background: #667eea;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .audio-bar.active {
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connection-indicator.idle {
            background: #ccc;
        }
        
        .connection-indicator.connecting {
            background: #ffc107;
            animation: blink 1s infinite;
        }
        
        .connection-indicator.connected {
            background: #28a745;
        }
        
        .connection-indicator.error {
            background: #dc3545;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì AI Course Tutor</h1>
        
        <div class="status">
            <span class="connection-indicator idle" id="connectionIndicator"></span>
            <span id="statusText">Ready to start</span>
        </div>
        
        <div class="audio-indicator" id="audioIndicator">
            <div class="audio-bar" style="height: 20px;"></div>
            <div class="audio-bar" style="height: 30px;"></div>
            <div class="audio-bar" style="height: 25px;"></div>
            <div class="audio-bar" style="height: 35px;"></div>
            <div class="audio-bar" style="height: 28px;"></div>
        </div>
        
        <button class="main-button" id="mainButton" onclick="handleMainButton()">
            Start Conversation
        </button>
        
        <div class="error-message hidden" id="errorMessage"></div>
        
        <div class="info-text">
            Click to start talking with your AI tutor about the course content.
        </div>
    </div>
    
    <audio id="remoteAudio" autoplay playsinline style="display: none;"></audio>
    
    <script>
        // Configuration
        const REALTIME_MODEL = "gpt-4o-mini-realtime-preview-2024-12-17";
        const API_ENDPOINT = "/api/realtime/offer";
        
        // Course content will be loaded here
        let COURSE_CONTENT = "";
        
        // Load course content from markdown file
        async function loadCourseContent() {
            try {
                const response = await fetch('/course-content.md');
                if (response.ok) {
                    COURSE_CONTENT = await response.text();
                    console.log('Course content loaded successfully');
                } else {
                    console.warn('Could not load course content, using default');
                }
            } catch (error) {
                console.warn('Error loading course content:', error);
            }
        }
        
        // Load content on page load
        loadCourseContent();
        
        // State
        let state = 'idle'; // idle, connecting, connected, error
        let pc = null;
        let dc = null;
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let animationFrame = null;
        
        // UI Elements
        const statusText = document.getElementById('statusText');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const mainButton = document.getElementById('mainButton');
        const errorMessage = document.getElementById('errorMessage');
        const audioIndicator = document.getElementById('audioIndicator');
        const remoteAudio = document.getElementById('remoteAudio');
        
        function updateUI() {
            // Update connection indicator
            connectionIndicator.className = `connection-indicator ${state}`;
            
            // Update button
            switch(state) {
                case 'idle':
                    mainButton.textContent = 'Start Conversation';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button';
                    statusText.textContent = 'Ready to start';
                    break;
                case 'connecting':
                    mainButton.textContent = 'Connecting...';
                    mainButton.disabled = true;
                    statusText.textContent = 'Setting up connection...';
                    break;
                case 'connected':
                    mainButton.textContent = 'End Conversation';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button stop';
                    statusText.textContent = 'Connected - Start speaking!';
                    break;
                case 'error':
                    mainButton.textContent = 'Try Again';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button';
                    break;
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        function animateAudioBars(level = 0) {
            const bars = audioIndicator.querySelectorAll('.audio-bar');
            bars.forEach((bar, index) => {
                const baseHeight = 20 + (index * 5);
                const variance = Math.random() * level * 0.5;
                bar.style.height = `${baseHeight + variance}px`;
                
                if (level > 10) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
        
        async function startSession() {
            console.log('üé¨ Starting session...');
            try {
                state = 'connecting';
                updateUI();
                
                // Get microphone access
                console.log('üìç Step 1: Requesting microphone...');
                statusText.textContent = 'Requesting microphone access...';
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    }
                });
                console.log('‚úÖ Microphone access granted');
                
                // Set up audio monitoring
                console.log('üìç Step 2: Setting up audio monitoring...');
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                
                // Monitor audio levels
                const monitorAudio = () => {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    animateAudioBars(average);
                    animationFrame = requestAnimationFrame(monitorAudio);
                };
                monitorAudio();
                console.log('‚úÖ Audio monitoring active');
                
                // Create WebRTC connection
                console.log('üìç Step 3: Creating WebRTC connection...');
                statusText.textContent = 'Creating connection...';
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add debugging for connection states
                pc.oniceconnectionstatechange = () => {
                    console.log('üîå ICE connection state:', pc.iceConnectionState);
                };
                
                pc.onconnectionstatechange = () => {
                    console.log('üîå Connection state:', pc.connectionState);
                };
                
                // Add audio track
                const audioTrack = localStream.getAudioTracks()[0];
                pc.addTrack(audioTrack, localStream);
                console.log('‚úÖ Audio track added');
                
                // Handle incoming audio
                pc.ontrack = (event) => {
                    console.log('üìû Received remote track');
                    remoteAudio.srcObject = event.streams[0];
                };
                
                // Create data channel for OpenAI events
                console.log('üìç Step 4: Creating data channel...');
                dc = pc.createDataChannel('oai-events');
                
                dc.onopen = () => {
                    console.log('‚úÖ Data channel opened');
                    state = 'connected';
                    updateUI();
                    
                    // Configure the AI tutor with course content
                    const instructions = COURSE_CONTENT ? 
                        `You are an AI tutor helping learners with this training course. 
                         
                         COURSE CONTENT:
                         ${COURSE_CONTENT}
                         
                         Your role:
                         - Answer questions about the training material
                         - Reference specific slides when relevant
                         - Guide learners through scenarios and activities
                         - Encourage reflection and understanding
                         - Stay friendly, supportive, and conversational
                         - If asked about something not in the course, politely redirect to the material
                         
                         Keep responses concise for voice conversation.` :
                        `You are a friendly AI tutor. Help the learner understand the course material and answer their questions.`;
                    
                    console.log('üì§ Sending session configuration...');
                    // Send session configuration
                    dc.send(JSON.stringify({
                        type: "session.update",
                        session: {
                            modalities: ["audio", "text"],
                            voice: "alloy",
                            instructions: instructions,
                            turn_detection: {
                                type: "server_vad",
                                threshold: 0.5,
                                prefix_padding_ms: 300,
                                silence_duration_ms: 500
                            }
                        }
                    }));
                };
                
                dc.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    console.log('üì• Received message:', msg.type);
                    
                    if (msg.type === 'error') {
                        console.error('‚ùå Error from OpenAI:', msg.error);
                        showError(msg.error?.message || 'An error occurred');
                    }
                };
                
                dc.onerror = (error) => {
                    console.error('‚ùå Data channel error:', error);
                };
                
                dc.onclose = () => {
                    console.log('üì™ Data channel closed');
                };
                
                // Create and send offer
                console.log('üìç Step 5: Creating offer...');
                statusText.textContent = 'Creating offer...';
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                console.log('‚úÖ Offer created');
                
                // Wait for ICE gathering with timeout
                console.log('üìç Step 6: Gathering ICE candidates...');
                statusText.textContent = 'Gathering connection details...';
                await new Promise((resolve) => {
                    let timeout;
                    const checkState = () => {
                        console.log('üßä ICE gathering state:', pc.iceGatheringState);
                        if (pc.iceGatheringState === 'complete') {
                            clearTimeout(timeout);
                            resolve();
                        }
                    };
                    
                    pc.onicegatheringstatechange = checkState;
                    checkState();
                    
                    // Timeout after 5 seconds
                    timeout = setTimeout(() => {
                        console.warn('‚ö†Ô∏è ICE gathering timeout, proceeding anyway');
                        resolve();
                    }, 5000);
                });
                console.log('‚úÖ ICE candidates gathered');
                
                // Send offer to server - USING JSON FORMAT
                console.log('üìç Step 7: Sending to OpenAI...');
                statusText.textContent = 'Connecting to AI service...';
                const apiUrl = API_ENDPOINT + `?model=${REALTIME_MODEL}`;
                console.log('üåê API URL:', apiUrl);
                console.log('üì§ Sending SDP offer (length:', pc.localDescription.sdp.length, ')');
                
                // Send as JSON instead of raw SDP
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sdp: pc.localDescription.sdp 
                    })
                });
                
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Server error:', errorText);
                    throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
                
                // Parse JSON response
                const responseData = await response.json();
                const answer = responseData.sdp || responseData;
                console.log('‚úÖ Received answer (length:', answer.length, ')');
                
                console.log('üìç Step 8: Setting remote description...');
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });
                console.log('‚úÖ Remote description set - connection should establish');
                
                statusText.textContent = 'Waiting for connection...';
                
            } catch (error) {
                console.error('‚ùå Session error:', error);
                showError(error.message);
                state = 'error';
                updateUI();
                stopSession();
            }
        }
        
        function stopSession() {
            state = 'idle';
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            if (audioContext) {
                audioContext.close();
            }
            
            if (dc) {
                dc.close();
            }
            
            if (pc) {
                pc.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            animateAudioBars(0);
            updateUI();
        }
        
        function handleMainButton() {
            switch(state) {
                case 'idle':
                case 'error':
                    startSession();
                    break;
                case 'connected':
                    stopSession();
                    break;
            }
        }
        
        // Initialize
        updateUI();
    </script>
</body>
</html>