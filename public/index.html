<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Course Tutor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .slide-info {
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        
        .slide-info strong {
            color: #333;
        }
        
        .status {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .main-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .main-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .main-button.stop {
            background: #dc3545;
        }
        
        .main-button.stop:hover {
            background: #c82333;
        }
        
        .main-button.pulse {
            animation: pulse-button 2s infinite;
        }
        
        @keyframes pulse-button {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
        
        .audio-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            height: 60px;
        }
        
        .audio-bar {
            width: 4px;
            background: #667eea;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .audio-bar.active {
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connection-indicator.idle {
            background: #ccc;
        }
        
        .connection-indicator.connecting {
            background: #ffc107;
            animation: blink 1s infinite;
        }
        
        .connection-indicator.connected {
            background: #28a745;
        }
        
        .connection-indicator.error {
            background: #dc3545;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        .auto-start-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ“ AI Course Tutor</h1>
        
        <div class="slide-info" id="slideInfo">
            <strong>Current Slide:</strong> <span id="slideName">Loading...</span>
        </div>
        
        <div class="auto-start-notice hidden" id="autoStartNotice">
            ðŸ”„ Auto-starting session...
        </div>
        
        <div class="status">
            <span class="connection-indicator idle" id="connectionIndicator"></span>
            <span id="statusText">Ready to start</span>
        </div>
        
        <div class="audio-indicator" id="audioIndicator">
            <div class="audio-bar" style="height: 20px;"></div>
            <div class="audio-bar" style="height: 30px;"></div>
            <div class="audio-bar" style="height: 25px;"></div>
            <div class="audio-bar" style="height: 35px;"></div>
            <div class="audio-bar" style="height: 28px;"></div>
        </div>
        
        <button class="main-button" id="mainButton" onclick="handleMainButton()">
            Start Conversation
        </button>
        
        <div class="error-message hidden" id="errorMessage"></div>
        
        <div class="info-text">
            Click to start talking with your AI tutor about the course content.
        </div>
    </div>
    
    <audio id="remoteAudio" autoplay playsinline style="display: none;"></audio>
    
    <script>
        // Configuration
        const REALTIME_MODEL = "gpt-4o-mini-realtime-preview-2024-12-17";
        const API_ENDPOINT = "/api/realtime/offer";
        
        // Course content will be loaded here
        let COURSE_CONTENT = "";
        
        // Storyline integration variables
        let storylineData = {
            currentSlide: 'Unknown Slide',
            hasStartedBefore: false,
            isAutoStarting: false
        };
        
        // State
        let state = 'idle';
        let pc = null;
        let dc = null;
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let animationFrame = null;
        
        // UI Elements
        const statusText = document.getElementById('statusText');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const mainButton = document.getElementById('mainButton');
        const errorMessage = document.getElementById('errorMessage');
        const audioIndicator = document.getElementById('audioIndicator');
        const remoteAudio = document.getElementById('remoteAudio');
        const slideName = document.getElementById('slideName');
        const autoStartNotice = document.getElementById('autoStartNotice');
        
        // Load course content
        async function loadCourseContent() {
            try {
                const response = await fetch('/course-content.md');
                if (response.ok) {
                    COURSE_CONTENT = await response.text();
                    console.log('Course content loaded successfully');
                }
            } catch (error) {
                console.warn('Error loading course content:', error);
            }
        }
        
        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Try to get Storyline player
        function getStorylinePlayer() {
            try {
                if (window.parent && window.parent.GetPlayer) {
                    return window.parent.GetPlayer();
                }
            } catch (e) {
                console.log('Not embedded in Storyline or access denied');
            }
            return null;
        }
        
        // Initialize Storyline communication
        function initializeStorylineCommunication() {
            console.log('Initializing Storyline communication...');
            
            // Check URL parameters first
            const slideParam = getUrlParameter('slide');
            const startedParam = getUrlParameter('started');
            
            if (slideParam && slideParam !== 'null') {
                storylineData.currentSlide = decodeURIComponent(slideParam);
                slideName.textContent = storylineData.currentSlide;
                console.log('Got slide from URL:', storylineData.currentSlide);
            }
            
            if (startedParam === 'true') {
                storylineData.hasStartedBefore = true;
                console.log('Got TutorStarted from URL');
            }
            
            // Auto-start if microphone was previously authorized
            if (storylineData.hasStartedBefore && state === 'idle') {
                console.log('Auto-starting (microphone authorized)...');
                storylineData.isAutoStarting = true;
                autoStartNotice.classList.remove('hidden');
                autoStartNotice.textContent = 'ðŸ”„ Starting tutor automatically...';
                
                setTimeout(() => {
                    startSession(true);
                }, 1000);
            } else if (state === 'idle') {
                console.log('First time - need microphone permission');
                statusText.textContent = 'Click Start to enable microphone';
            }
        }
        
        // Listen for messages from parent window - set up immediately
        console.log('Setting up message listener...');
        window.addEventListener('message', (event) => {
            // Log EVERY message for debugging
            console.log('=== MESSAGE RECEIVED ===');
            console.log('From origin:', event.origin);
            console.log('Data:', event.data);
            
            try {
                const data = event.data;
                
                if (data.type === 'storylineData' || data.type === 'slideChange') {
                    console.log('âœ… This is Storyline data!');
                    
                    if (data.slideName && data.slideName !== 'null' && data.slideName !== 'Unknown Slide') {
                        storylineData.currentSlide = data.slideName;
                        slideName.textContent = data.slideName;
                        console.log('âœ… Updated slide display to:', data.slideName);
                    }
                    
                    if (data.tutorStarted !== undefined) {
                        storylineData.hasStartedBefore = (data.tutorStarted === true || data.tutorStarted === 'true');
                        console.log('âœ… TutorStarted status:', storylineData.hasStartedBefore);
                        
                        // Auto-start if just became true
                        if (storylineData.hasStartedBefore && state === 'idle' && !storylineData.isAutoStarting) {
                            console.log('âœ… Auto-starting on status change...');
                            storylineData.isAutoStarting = true;
                            autoStartNotice.classList.remove('hidden');
                            setTimeout(() => {
                                startSession(true);
                            }, 800);
                        }
                    }
                    
                    // Send slide change to AI if connected
                    if (dc && dc.readyState === 'open' && data.slideName) {
                        dc.send(JSON.stringify({
                            type: "conversation.item.create",
                            item: {
                                type: "message",
                                role: "system",
                                content: [{
                                    type: "text",
                                    text: `User has navigated to slide: "${data.slideName}"`
                                }]
                            }
                        }));
                        console.log('âœ… Sent slide change to AI');
                    }
                }
            } catch (e) {
                console.log('âŒ Error processing message:', e);
            }
        });
        console.log('Message listener ready!');
        
        // Update UI based on state
        function updateUI() {
            connectionIndicator.className = `connection-indicator ${state}`;
            
            switch(state) {
                case 'idle':
                    mainButton.textContent = storylineData.isAutoStarting ? 'Auto-starting...' : 'Start Conversation';
                    mainButton.disabled = storylineData.isAutoStarting;
                    mainButton.className = 'main-button';
                    statusText.textContent = storylineData.isAutoStarting ? 'Auto-starting session...' : 'Ready to start';
                    break;
                case 'connecting':
                    mainButton.textContent = 'Connecting...';
                    mainButton.disabled = true;
                    statusText.textContent = 'Setting up connection...';
                    break;
                case 'connected':
                    mainButton.textContent = 'End Conversation';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button stop';
                    statusText.textContent = 'Connected - Start speaking!';
                    break;
                case 'error':
                    mainButton.textContent = 'Try Again';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button';
                    break;
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        function animateAudioBars(level = 0) {
            const bars = audioIndicator.querySelectorAll('.audio-bar');
            bars.forEach((bar, index) => {
                const baseHeight = 20 + (index * 5);
                const variance = Math.random() * level * 0.5;
                bar.style.height = `${baseHeight + variance}px`;
                
                if (level > 10) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
        
        async function startSession(isAutoStart = false) {
            console.log('Starting session...', isAutoStart ? '(auto-start)' : '(manual)');
            
            autoStartNotice.classList.add('hidden');
            storylineData.isAutoStarting = false;
            
            // Set TutorStarted to true
            if (!storylineData.hasStartedBefore) {
                try {
                    sessionStorage.setItem('microphoneAuthorized', 'true');
                } catch(e) {}
                
                // Try to notify parent
                try {
                    window.parent.postMessage({
                        type: 'setStorylineVariable',
                        variable: 'TutorStarted',
                        value: true
                    }, '*');
                    storylineData.hasStartedBefore = true;
                    console.log('Sent message to parent to set TutorStarted');
                } catch (e) {
                    console.log('Could not send message to parent:', e);
                }
            }
            
            try {
                state = 'connecting';
                updateUI();
                
                // Get microphone
                statusText.textContent = 'Requesting microphone access...';
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    }
                });
                console.log('Microphone access granted');
                
                // Set up audio monitoring
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                
                const monitorAudio = () => {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    animateAudioBars(average);
                    animationFrame = requestAnimationFrame(monitorAudio);
                };
                monitorAudio();
                
                // Create WebRTC connection
                statusText.textContent = 'Creating connection...';
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.oniceconnectionstatechange = () => {
                    console.log('ICE connection state:', pc.iceConnectionState);
                };
                
                pc.onconnectionstatechange = () => {
                    console.log('Connection state:', pc.connectionState);
                };
                
                const audioTrack = localStream.getAudioTracks()[0];
                pc.addTrack(audioTrack, localStream);
                
                pc.ontrack = (event) => {
                    console.log('Received remote track');
                    remoteAudio.srcObject = event.streams[0];
                };
                
                // Create data channel
                dc = pc.createDataChannel('oai-events');
                
                dc.onopen = () => {
                    console.log('Data channel opened');
                    state = 'connected';
                    updateUI();
                    
                    const currentSlideContext = storylineData.currentSlide !== 'Unknown Slide' ? 
                        `The learner is currently on the slide titled: "${storylineData.currentSlide}".` : '';
                    
                    const greeting = isAutoStart ? 
                        `The learner has returned and is continuing from "${storylineData.currentSlide}".` :
                        `The learner has just started on "${storylineData.currentSlide}".`;
                    
                    const instructions = COURSE_CONTENT ? 
                        `You are an AI tutor helping with this training course. 
                         
                         COURSE CONTENT:
                         ${COURSE_CONTENT}
                         
                         CURRENT CONTEXT:
                         ${greeting}
                         ${currentSlideContext}
                         
                         Your role:
                         - Answer questions about the training material
                         - Reference the current slide when relevant
                         - Guide learners through activities
                         - Stay friendly and conversational
                         
                         Keep responses concise for voice conversation.` :
                        `You are a friendly AI tutor. The learner is on "${storylineData.currentSlide}". Help them with the course material.`;
                    
                    // Send session configuration
                    dc.send(JSON.stringify({
                        type: "session.update",
                        session: {
                            modalities: ["audio", "text"],
                            voice: "alloy",
                            instructions: instructions,
                            turn_detection: {
                                type: "server_vad",
                                threshold: 0.5,
                                prefix_padding_ms: 300,
                                silence_duration_ms: 500
                            }
                        }
                    }));
                };
                
                dc.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    console.log('Received from OpenAI:', msg.type);
                    
                    if (msg.type === 'error') {
                        console.error('OpenAI error:', msg.error);
                        showError(msg.error?.message || 'An error occurred');
                    }
                };
                
                dc.onerror = (error) => {
                    console.error('Data channel error:', error);
                };
                
                dc.onclose = () => {
                    console.log('Data channel closed');
                };
                
                // Create offer
                statusText.textContent = 'Creating offer...';
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Wait for ICE gathering
                statusText.textContent = 'Gathering connection details...';
                await new Promise((resolve) => {
                    let timeout;
                    const checkState = () => {
                        if (pc.iceGatheringState === 'complete') {
                            clearTimeout(timeout);
                            resolve();
                        }
                    };
                    
                    pc.onicegatheringstatechange = checkState;
                    checkState();
                    
                    timeout = setTimeout(() => {
                        console.warn('ICE gathering timeout, proceeding');
                        resolve();
                    }, 5000);
                });
                
                // Send to server
                statusText.textContent = 'Connecting to AI service...';
                const apiUrl = API_ENDPOINT + `?model=${REALTIME_MODEL}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sdp: pc.localDescription.sdp 
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
                
                const responseData = await response.json();
                const answer = responseData.sdp || responseData;
                
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });
                
                statusText.textContent = 'Waiting for connection...';
                
            } catch (error) {
                console.error('Session error:', error);
                showError(error.message);
                state = 'error';
                storylineData.isAutoStarting = false;
                autoStartNotice.classList.add('hidden');
                updateUI();
                stopSession();
            }
        }
        
        function stopSession() {
            state = 'idle';
            storylineData.isAutoStarting = false;
            autoStartNotice.classList.add('hidden');
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            if (audioContext) {
                audioContext.close();
            }
            
            if (dc) {
                dc.close();
            }
            
            if (pc) {
                pc.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            animateAudioBars(0);
            updateUI();
        }
        
        function handleMainButton() {
            switch(state) {
                case 'idle':
                case 'error':
                    startSession(false);
                    break;
                case 'connected':
                    stopSession();
                    break;
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            loadCourseContent();
            initializeStorylineCommunication();
            updateUI();
        });
        
        // Initialize immediately if already loaded
        if (document.readyState === 'complete') {
            loadCourseContent();
            initializeStorylineCommunication();
            updateUI();
        }
    </script>
</body>
</html>