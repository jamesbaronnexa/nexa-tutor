        // Initialize Storyline communication
        function initializeStorylineCommunication() {
            console.log('Initializing Storyline communication...');
            
            // Method 1: Check if variables were set directly on window
            if (window.storylineSlide) {
                storylineData.currentSlide = window.storylineSlide;
                slideName.textContent = window.storylineSlide;
                console.log('Got slide from window.storylineSlide:', window.storylineSlide);
            }
            
            if (window.storylineTutorStarted !== undefined) {
                storylineData.hasStartedBefore = window.storylineTutorStarted;
                console.log('Got TutorStarted from window.storylineTutorStarted:', window.storylineTutorStarted);
            }
            
            // Method 2: Try to get Storyline player (usually won't work due to sandboxing)
            const player = getStorylinePlayer();
            
            if (player) {
                try {
                    const currentSlide = player.GetVar("CurrentSlide");
                    if (currentSlide && currentSlide !== "null") {
                        storylineData.currentSlide = currentSlide;
                        slideName.textContent = currentSlide;
                        console.log('Got CurrentSlide from Storyline player:', currentSlide);
                    }
                    
                    const hasStarted = player.GetVar("TutorStarted");
                    if (hasStarted === true || hasStarted === "true") {
                        storylineData.hasStartedBefore = true;
                        console.log('Got TutorStarted from Storyline player');
                    }
                } catch (e) {
                    console.log('Cannot access Storyline player (normal in sandboxed iframe)');
                }
            }
            
            // Method 3: Check URL parameters
            const slideParam = getUrlParameter('slide');
            const startedParam = getUrlParameter('started');
            
            if (slideParam && slideParam !== 'null') {
                storylineData.currentSlide = decodeURIComponent(slideParam);
                slideName.textContent = storylineData.currentSlide;
                console.log('Got slide from URL:', storylineData.currentSlide);
            }
            
            if (startedParam === 'true') {
                storylineData.hasStartedBefore = true;
                console.log('Got TutorStarted from URL');
            }
            
            // Auto-start if microphone was previously authorized
            if (storylineData.hasStartedBefore && state === 'idle') {
                console.log('Auto-starting (microphone authorized)...');
                storylineData.isAutoStarting = true;
                autoStartNotice.classList.remove('hidden');
                autoStartNotice.textContent = 'ðŸ”„ Starting tutor automatically...';
                
                setTimeout(() => {
                    startSession(true);
                }, 1000);
            } else if (state === 'idle') {
                console.log('First time - need microphone permission');
                statusText.textContent = 'Click Start to enable microphone';
                mainButton.classList.add('pulse');
            }
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Course Tutor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .slide-info {
            background: #f0f4f8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        
        .slide-info strong {
            color: #333;
        }
        
        .status {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .main-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .main-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .main-button.stop {
            background: #dc3545;
        }
        
        .main-button.stop:hover {
            background: #c82333;
        }
        
        .audio-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            height: 60px;
        }
        
        .audio-bar {
            width: 4px;
            background: #667eea;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .audio-bar.active {
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connection-indicator.idle {
            background: #ccc;
        }
        
        .connection-indicator.connecting {
            background: #ffc107;
            animation: blink 1s infinite;
        }
        
        .connection-indicator.connected {
            background: #28a745;
        }
        
        .connection-indicator.error {
            background: #dc3545;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }
        
        .auto-start-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ“ AI Course Tutor</h1>
        
        <div class="slide-info" id="slideInfo">
            <strong>Current Slide:</strong> <span id="slideName">Loading...</span>
        </div>
        
        <div class="auto-start-notice hidden" id="autoStartNotice">
            ðŸ”„ Auto-starting session...
        </div>
        
        <div class="status">
            <span class="connection-indicator idle" id="connectionIndicator"></span>
            <span id="statusText">Ready to start</span>
        </div>
        
        <div class="audio-indicator" id="audioIndicator">
            <div class="audio-bar" style="height: 20px;"></div>
            <div class="audio-bar" style="height: 30px;"></div>
            <div class="audio-bar" style="height: 25px;"></div>
            <div class="audio-bar" style="height: 35px;"></div>
            <div class="audio-bar" style="height: 28px;"></div>
        </div>
        
        <button class="main-button" id="mainButton" onclick="handleMainButton()">
            Start Conversation
        </button>
        
        <div class="error-message hidden" id="errorMessage"></div>
        
        <div class="info-text">
            Click to start talking with your AI tutor about the course content.
        </div>
    </div>
    
    <audio id="remoteAudio" autoplay playsinline style="display: none;"></audio>
    
    <script>
        // Configuration
        const REALTIME_MODEL = "gpt-4o-mini-realtime-preview-2024-12-17";
        const API_ENDPOINT = "/api/realtime/offer";
        
        // Course content will be loaded here
        let COURSE_CONTENT = "";
        
        // Storyline integration variables
        let storylineData = {
            currentSlide: 'Unknown Slide',
            hasStartedBefore: false,
            isAutoStarting: false
        };
        
        // State
        let state = 'idle'; // idle, connecting, connected, error
        let pc = null;
        let dc = null;
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let animationFrame = null;
        
        // UI Elements
        const statusText = document.getElementById('statusText');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const mainButton = document.getElementById('mainButton');
        const errorMessage = document.getElementById('errorMessage');
        const audioIndicator = document.getElementById('audioIndicator');
        const remoteAudio = document.getElementById('remoteAudio');
        const slideName = document.getElementById('slideName');
        const autoStartNotice = document.getElementById('autoStartNotice');
        
        // Load course content from markdown file
        async function loadCourseContent() {
            try {
                const response = await fetch('/course-content.md');
                if (response.ok) {
                    COURSE_CONTENT = await response.text();
                    console.log('Course content loaded successfully');
                } else {
                    console.warn('Could not load course content, using default');
                }
            } catch (error) {
                console.warn('Error loading course content:', error);
            }
        }
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Function to get Storyline player if embedded
        function getStorylinePlayer() {
            try {
                if (window.parent && window.parent.GetPlayer) {
                    return window.parent.GetPlayer();
                }
            } catch (e) {
                console.log('Not embedded in Storyline or access denied');
            }
            return null;
        }
        
        // Initialize Storyline communication
        function initializeStorylineCommunication() {
            console.log('Initializing Storyline communication...');
            
            // Try to get Storyline player
            const player = getStorylinePlayer();
            
            if (player) {
                try {
                    // Get current slide name using Project.SlideTitle
                    const slideTitle = player.GetVar("Project.SlideTitle");
                    if (slideTitle) {
                        storylineData.currentSlide = slideTitle;
                        slideName.textContent = slideTitle;
                        console.log('Got slide from Storyline:', slideTitle);
                    }
                    
                    // Check if tutor has been started before
                    const hasStarted = player.GetVar("TutorStarted");
                    if (hasStarted === true || hasStarted === "true") {
                        storylineData.hasStartedBefore = true;
                        console.log('Tutor has been started before');
                    }
                    
                    // Set TutorStarted to true once we start
                    if (!storylineData.hasStartedBefore && state === 'idle') {
                        // Will be set when user clicks start
                    }
                } catch (e) {
                    console.log('Error getting Storyline variables:', e);
                }
            }
            
            // Also check URL parameters as fallback
            const slideParam = getUrlParameter('slide');
            const startedParam = getUrlParameter('started');
            
            if (slideParam) {
                storylineData.currentSlide = decodeURIComponent(slideParam);
                slideName.textContent = storylineData.currentSlide;
                console.log('Got slide from URL:', storylineData.currentSlide);
            }
            
            if (startedParam === 'true') {
                storylineData.hasStartedBefore = true;
                console.log('Started param is true');
            }
            
            // Auto-start if user has started before and we're not already connected
            if (storylineData.hasStartedBefore && state === 'idle') {
                console.log('Auto-starting session...');
                storylineData.isAutoStarting = true;
                autoStartNotice.classList.remove('hidden');
                
                // Small delay to show the notice
                setTimeout(() => {
                    startSession(true);
                }, 1500);
            }
        }
        
        // Listen for messages from parent window (Storyline)
        window.addEventListener('message', (event) => {
            try {
                const data = event.data;
                console.log('Received message:', data);
                
                if (data.type === 'slideChange') {
                    storylineData.currentSlide = data.slideName;
                    slideName.textContent = data.slideName;
                    
                    // Update tutor started status
                    if (data.tutorStarted !== undefined) {
                        storylineData.hasStartedBefore = data.tutorStarted;
                    }
                    
                    // If connected, send slide change to AI
                    if (dc && dc.readyState === 'open') {
                        dc.send(JSON.stringify({
                            type: "conversation.item.create",
                            item: {
                                type: "message",
                                role: "system",
                                content: [{
                                    type: "text",
                                    text: `User has navigated to slide: "${data.slideName}"`
                                }]
                            }
                        }));
                    }
                    
                    // Auto-start on slide change if previously started
                    if (storylineData.hasStartedBefore && state === 'idle') {
                        console.log('Auto-starting on slide change...');
                        storylineData.isAutoStarting = true;
                        autoStartNotice.classList.remove('hidden');
                        setTimeout(() => {
                            startSession(true);
                        }, 1500);
                    }
                }
            } catch (e) {
                console.log('Error processing message:', e);
            }
        });
        
        function updateUI() {
            // Update connection indicator
            connectionIndicator.className = `connection-indicator ${state}`;
            
            // Update button
            switch(state) {
                case 'idle':
                    mainButton.textContent = storylineData.isAutoStarting ? 'Auto-starting...' : 'Start Conversation';
                    mainButton.disabled = storylineData.isAutoStarting;
                    mainButton.className = 'main-button';
                    statusText.textContent = storylineData.isAutoStarting ? 'Auto-starting session...' : 'Ready to start';
                    break;
                case 'connecting':
                    mainButton.textContent = 'Connecting...';
                    mainButton.disabled = true;
                    statusText.textContent = 'Setting up connection...';
                    break;
                case 'connected':
                    mainButton.textContent = 'End Conversation';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button stop';
                    statusText.textContent = 'Connected - Start speaking!';
                    break;
                case 'error':
                    mainButton.textContent = 'Try Again';
                    mainButton.disabled = false;
                    mainButton.className = 'main-button';
                    break;
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        function animateAudioBars(level = 0) {
            const bars = audioIndicator.querySelectorAll('.audio-bar');
            bars.forEach((bar, index) => {
                const baseHeight = 20 + (index * 5);
                const variance = Math.random() * level * 0.5;
                bar.style.height = `${baseHeight + variance}px`;
                
                if (level > 10) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
        
        async function startSession(isAutoStart = false) {
            console.log('ðŸŽ¬ Starting session...', isAutoStart ? '(auto-start)' : '(manual)');
            
            // Hide auto-start notice
            autoStartNotice.classList.add('hidden');
            storylineData.isAutoStarting = false;
            
            // Set TutorStarted to true in Storyline
            if (!storylineData.hasStartedBefore) {
                // Mark that microphone has been authorized (persists across sessions)
                try {
                    sessionStorage.setItem('microphoneAuthorized', 'true');
                } catch(e) {}
                
                // Method 1: Try direct access to Storyline player
                const player = getStorylinePlayer();
                if (player) {
                    try {
                        player.SetVar("TutorStarted", true);
                        storylineData.hasStartedBefore = true;
                        console.log('Set TutorStarted to true in Storyline');
                    } catch (e) {
                        console.log('Could not set Storyline variable directly:', e);
                    }
                }
                
                // Method 2: Send message to parent to set the variable
                try {
                    window.parent.postMessage({
                        type: 'setStorylineVariable',
                        variable: 'TutorStarted',
                        value: true
                    }, '*');
                    storylineData.hasStartedBefore = true;
                    console.log('Sent message to parent to set TutorStarted');
                } catch (e) {
                    console.log('Could not send message to parent:', e);
                }
            }
            
            try {
                state = 'connecting';
                updateUI();
                
                // Get microphone access
                console.log('ðŸ“ Step 1: Requesting microphone...');
                statusText.textContent = 'Requesting microphone access...';
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                    }
                });
                console.log('âœ… Microphone access granted');
                
                // Set up audio monitoring
                console.log('ðŸ“ Step 2: Setting up audio monitoring...');
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                
                // Monitor audio levels
                const monitorAudio = () => {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    animateAudioBars(average);
                    animationFrame = requestAnimationFrame(monitorAudio);
                };
                monitorAudio();
                console.log('âœ… Audio monitoring active');
                
                // Create WebRTC connection
                console.log('ðŸ“ Step 3: Creating WebRTC connection...');
                statusText.textContent = 'Creating connection...';
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add debugging for connection states
                pc.oniceconnectionstatechange = () => {
                    console.log('ðŸ”Œ ICE connection state:', pc.iceConnectionState);
                };
                
                pc.onconnectionstatechange = () => {
                    console.log('ðŸ”Œ Connection state:', pc.connectionState);
                };
                
                // Add audio track
                const audioTrack = localStream.getAudioTracks()[0];
                pc.addTrack(audioTrack, localStream);
                console.log('âœ… Audio track added');
                
                // Handle incoming audio
                pc.ontrack = (event) => {
                    console.log('ðŸ“ž Received remote track');
                    remoteAudio.srcObject = event.streams[0];
                };
                
                // Create data channel for OpenAI events
                console.log('ðŸ“ Step 4: Creating data channel...');
                dc = pc.createDataChannel('oai-events');
                
                dc.onopen = () => {
                    console.log('âœ… Data channel opened');
                    state = 'connected';
                    updateUI();
                    
                    // Create context-aware instructions
                    const currentSlideContext = storylineData.currentSlide !== 'Unknown Slide' ? 
                        `The learner is currently on the slide titled: "${storylineData.currentSlide}".` : '';
                    
                    const greeting = isAutoStart ? 
                        `The learner has returned to the course and is continuing from "${storylineData.currentSlide}".` :
                        `The learner has just started the tutor for the first time on "${storylineData.currentSlide}".`;
                    
                    // Configure the AI tutor with course content
                    const instructions = COURSE_CONTENT ? 
                        `You are an AI tutor helping learners with this training course. 
                         
                         COURSE CONTENT:
                         ${COURSE_CONTENT}
                         
                         CURRENT CONTEXT:
                         ${greeting}
                         ${currentSlideContext}
                         
                         Your role:
                         - Answer questions about the training material
                         - Reference the current slide ("${storylineData.currentSlide}") when relevant
                         - Guide learners through scenarios and activities
                         - Encourage reflection and understanding
                         - Stay friendly, supportive, and conversational
                         - If asked about something not in the course, politely redirect to the material
                         
                         ${isAutoStart ? 'Welcome the learner back and ask if they have questions about the current slide.' : 'Introduce yourself briefly and ask how you can help with the current slide.'}
                         
                         Keep responses concise for voice conversation.` :
                        `You are a friendly AI tutor. The learner is on "${storylineData.currentSlide}". Help them understand the course material and answer their questions.`;
                    
                    console.log('ðŸ“¤ Sending session configuration...');
                    // Send session configuration
                    dc.send(JSON.stringify({
                        type: "session.update",
                        session: {
                            modalities: ["audio", "text"],
                            voice: "alloy",
                            instructions: instructions,
                            turn_detection: {
                                type: "server_vad",
                                threshold: 0.5,
                                prefix_padding_ms: 300,
                                silence_duration_ms: 500
                            }
                        }
                    }));
                };
                
                dc.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    console.log('ðŸ“¥ Received message:', msg.type);
                    
                    if (msg.type === 'error') {
                        console.error('âŒ Error from OpenAI:', msg.error);
                        showError(msg.error?.message || 'An error occurred');
                    }
                };
                
                dc.onerror = (error) => {
                    console.error('âŒ Data channel error:', error);
                };
                
                dc.onclose = () => {
                    console.log('ðŸ“ª Data channel closed');
                };
                
                // Create and send offer
                console.log('ðŸ“ Step 5: Creating offer...');
                statusText.textContent = 'Creating offer...';
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                console.log('âœ… Offer created');
                
                // Wait for ICE gathering with timeout
                console.log('ðŸ“ Step 6: Gathering ICE candidates...');
                statusText.textContent = 'Gathering connection details...';
                await new Promise((resolve) => {
                    let timeout;
                    const checkState = () => {
                        console.log('ðŸ§Š ICE gathering state:', pc.iceGatheringState);
                        if (pc.iceGatheringState === 'complete') {
                            clearTimeout(timeout);
                            resolve();
                        }
                    };
                    
                    pc.onicegatheringstatechange = checkState;
                    checkState();
                    
                    // Timeout after 5 seconds
                    timeout = setTimeout(() => {
                        console.warn('âš ï¸ ICE gathering timeout, proceeding anyway');
                        resolve();
                    }, 5000);
                });
                console.log('âœ… ICE candidates gathered');
                
                // Send offer to server - USING JSON FORMAT
                console.log('ðŸ“ Step 7: Sending to OpenAI...');
                statusText.textContent = 'Connecting to AI service...';
                const apiUrl = API_ENDPOINT + `?model=${REALTIME_MODEL}`;
                console.log('ðŸŒ API URL:', apiUrl);
                console.log('ðŸ“¤ Sending SDP offer (length:', pc.localDescription.sdp.length, ')');
                
                // Send as JSON instead of raw SDP
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sdp: pc.localDescription.sdp 
                    })
                });
                
                console.log('ðŸ“¥ Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Server error:', errorText);
                    throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
                
                // Parse JSON response
                const responseData = await response.json();
                const answer = responseData.sdp || responseData;
                console.log('âœ… Received answer (length:', answer.length, ')');
                
                console.log('ðŸ“ Step 8: Setting remote description...');
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });
                console.log('âœ… Remote description set - connection should establish');
                
                statusText.textContent = 'Waiting for connection...';
                
            } catch (error) {
                console.error('âŒ Session error:', error);
                showError(error.message);
                state = 'error';
                storylineData.isAutoStarting = false;
                autoStartNotice.classList.add('hidden');
                updateUI();
                stopSession();
            }
        }
        
        function stopSession() {
            state = 'idle';
            storylineData.isAutoStarting = false;
            autoStartNotice.classList.add('hidden');
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            if (audioContext) {
                audioContext.close();
            }
            
            if (dc) {
                dc.close();
            }
            
            if (pc) {
                pc.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            animateAudioBars(0);
            updateUI();
        }
        
        function handleMainButton() {
            switch(state) {
                case 'idle':
                case 'error':
                    startSession(false);
                    break;
                case 'connected':
                    stopSession();
                    break;
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, initializing...');
            loadCourseContent();
            initializeStorylineCommunication();
            updateUI();
        });
        
        // Initialize immediately if already loaded
        if (document.readyState === 'complete') {
            loadCourseContent();
            initializeStorylineCommunication();
            updateUI();
        }
    </script>
</body>
</html>